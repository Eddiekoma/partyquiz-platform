// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// CORE: Users & Authentication
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Spotify OAuth tokens (PKCE flow)
  spotifyAccessToken  String? @db.Text
  spotifyRefreshToken String? @db.Text
  spotifyTokenExpiry  DateTime?

  accounts      Account[]
  sessions      Session[]
  ownedWorkspaces Workspace[] @relation("WorkspaceOwner")
  memberships   WorkspaceMember[]
  invitesSent   WorkspaceInvite[] @relation("WorkspaceInvitedBy")
  createdQuestions Question[] @relation("QuestionCreator")
  updatedQuestions Question[] @relation("QuestionUpdater")
  createdAssets Asset[] @relation("AssetCreator")
  hostedSessions LiveSession[] @relation("SessionHost")
  auditLogs     AuditLog[]

  @@index([email])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// WORKSPACES & MEMBERS
// ============================================

model Workspace {
  id           String   @id @default(cuid())
  name         String
  description  String?
  slug         String   @unique
  ownerId      String
  logo         String?  // URL to uploaded logo image in S3
  themeColor   String?  // Hex color code for brand theme (e.g., "#3B82F6")
  brandingJson Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  owner        User     @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members      WorkspaceMember[]
  invites      WorkspaceInvite[]
  questions    Question[]
  assets       Asset[]
  quizzes      Quiz[]
  sessions     LiveSession[]
  spotifyIntegration SpotifyIntegration?
  auditLogs    AuditLog[]

  @@index([slug])
  @@index([ownerId])
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        String   // OWNER, ADMIN, EDITOR, CONTRIBUTOR, VIEWER
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model WorkspaceInvite {
  id          String   @id @default(cuid())
  workspaceId String
  email       String
  role        String
  token       String   @unique
  invitedById String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  acceptedAt  DateTime?

  workspace  Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy  User      @relation("WorkspaceInvitedBy", fields: [invitedById], references: [id])

  @@index([workspaceId])
  @@index([token])
  @@index([email])
  @@index([invitedById])
}

// ============================================
// MEDIA & STORAGE
// ============================================

model Asset {
  id          String   @id @default(cuid())
  workspaceId String
  filename    String
  type        String   // IMAGE, AUDIO, VIDEO, OTHER
  storageKey  String
  mime        String
  size        Int
  width       Int?
  height      Int?
  duration    Int?     // seconds for audio/video
  createdBy   String
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User      @relation("AssetCreator", fields: [createdBy], references: [id])

  @@index([workspaceId])
  @@index([createdBy])
  @@index([type])
}

model SpotifyIntegration {
  id                     String   @id @default(cuid())
  workspaceId            String   @unique
  encryptedRefreshToken  String   @db.Text
  scopesJson             Json
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
}

// ============================================
// QUESTIONS & QUESTION BANK
// ============================================

model Question {
  id          String   @id @default(cuid())
  workspaceId String
  type        String   // QuestionType enum
  title       String
  prompt      String   @db.Text
  explanation String?  @db.Text
  difficulty  Int      @default(3)
  tagsJson    Json     @default("[]")
  status      String   @default("DRAFT") // DRAFT, PUBLISHED, ARCHIVED
  createdBy   String
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User      @relation("QuestionCreator", fields: [createdBy], references: [id])
  updater   User?     @relation("QuestionUpdater", fields: [updatedBy], references: [id])

  options   QuestionOption[]
  media     QuestionMedia[]
  quizItems QuizItem[]

  @@index([workspaceId])
  @@index([createdBy])
  @@index([type])
  @@index([status])
}

model QuestionOption {
  id         String  @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)
  order      Int

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

// Extensible media model (IMPLEMENTATION CONSTRAINT 1.3)
model QuestionMedia {
  id         String @id @default(cuid())
  questionId String
  provider   String // UPLOAD, SPOTIFY, YOUTUBE
  mediaType  String // IMAGE, AUDIO, VIDEO
  reference  Json   // Flexible: {trackId, videoId, assetId, etc.}
  metadata   Json?  // Optional: {startMs, durationMs, title, etc.}
  order      Int

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

// ============================================
// QUIZZES & QUIZ BUILDER
// ============================================

model Quiz {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  description String?  @db.Text
  isTemplate  Boolean  @default(false)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  rounds    QuizRound[]
  sessions  LiveSession[]

  @@index([workspaceId])
  @@index([isTemplate])
}

model QuizRound {
  id           String @id @default(cuid())
  quizId       String
  title        String
  order        Int
  defaultsJson Json?  // {timer, points, theme}

  quiz  Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  items QuizItem[]

  @@index([quizId])
}

model QuizItem {
  id           String  @id @default(cuid())
  quizRoundId  String
  order        Int
  itemType     String  // QUESTION, MINIGAME, BREAK
  questionId   String?
  minigameType String? // SWAN_RACE
  settingsJson Json?

  round    QuizRound @relation(fields: [quizRoundId], references: [id], onDelete: Cascade)
  question Question? @relation(fields: [questionId], references: [id], onDelete: SetNull)
  answers  LiveAnswer[]

  @@index([quizRoundId])
  @@index([questionId])
}

// ============================================
// LIVE SESSIONS
// ============================================

model LiveSession {
  id          String    @id @default(cuid())
  workspaceId String
  quizId      String
  code        String    @unique // 6-char code for joining
  status      String    // LOBBY, ITEM_INTRO, ITEM_ACTIVE, etc.
  hostUserId  String
  startedAt   DateTime  @default(now())
  endedAt     DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  quiz      Quiz      @relation(fields: [quizId], references: [id])
  host      User      @relation("SessionHost", fields: [hostUserId], references: [id])

  players   LivePlayer[]
  answers   LiveAnswer[]

  @@index([workspaceId])
  @@index([quizId])
  @@index([code])
  @@index([status])
}

model LivePlayer {
  id           String    @id @default(cuid())
  sessionId    String
  name         String
  avatar       String?
  deviceIdHash String
  joinedAt     DateTime  @default(now())
  leftAt       DateTime?

  session LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  answers LiveAnswer[]

  @@index([sessionId])
  @@index([deviceIdHash])
}

model LiveAnswer {
  id          String   @id @default(cuid())
  sessionId   String
  playerId    String
  quizItemId  String
  payloadJson Json     // Flexible answer format
  isCorrect   Boolean?
  score       Int      @default(0)
  answeredAt  DateTime @default(now())

  session  LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  player   LivePlayer  @relation(fields: [playerId], references: [id], onDelete: Cascade)
  quizItem QuizItem    @relation(fields: [quizItemId], references: [id])

  @@index([sessionId])
  @@index([playerId])
  @@index([quizItemId])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  workspaceId String
  actorUserId String?
  action      String
  entityType  String
  entityId    String?
  payloadJson Json?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  actor     User?     @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([actorUserId])
  @@index([entityType])
  @@index([createdAt])
}
